---
- name: Install prerequisite packages for Trivy
  apt:
    name:
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download Trivy GPG key (using curl to avoid Python HTTPS bug)
  shell: |
    curl -fsSL https://aquasecurity.github.io/trivy-repo/deb/public.key \
    -o /etc/apt/keyrings/trivy.asc
  args:
    creates: /etc/apt/keyrings/trivy.asc

- name: Set correct permissions on Trivy key
  file:
    path: /etc/apt/keyrings/trivy.asc
    mode: '0644'

- name: Add Trivy repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/trivy.asc] https://aquasecurity.github.io/trivy-repo/deb {{ ansible_distribution_release }} main"
    filename: trivy
    state: present
    update_cache: yes

- name: Install Trivy
  apt:
    name: trivy
    state: present
